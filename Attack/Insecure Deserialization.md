# Insecure Deserialization (안전하지 않은 역 직렬화)

https://portswigger.net/web-security/deserialization

https://cybersecuritykong.tistory.com/18

https://rsy99.tistory.com/61

### -- 2017 OWASP TOP 10 --
A8: Insecure Deserialization (안전하지 않은 역 직렬화)

안전하지 않은 역 직렬화는 종종 원격 코드 실행으로 이어집니다. 
역 직렬화 결함이 원격 코드 실행으로 이어지지 않더라도 재생 공격, 주입 공격 및 권한 상승 공격을 포함한 공격을 수행하는 데 사용될 수 있습니다.

<br><br>

## 안전한지 않은 역 직렬화 개요
취약점 발견시 원격에서 코드 실행 가능한REC(Remote Code Execution) 공격으로 이어질 수 있다.

직렬화되어 전송되는 데이터 변조 및 원격으로 실행되는 역직렬화시 문제 발생 코드를 추가하는 등의 공격으로 기존에 구성되어 있는 데이터 구조를 변경하는 공격이가능한 취약점이다.

안전하지 않은 역직렬화의 영향은 엄청나게 증가한 공격 표면에 대한 진입점을 제공하기 때문에 매우 심각할 수 있다. 
이는 공격자가 기존 애플리케이션 코드를 유해한 방식으로 재사용할 수 있게 하여 종종 원격 코드 실행과 같은 수많은 다른 취약성을 초래한다.

원격 코드 실행이 불가능한 경우에도 안전하지 않은 역직렬화는 권한 상승, 임의 파일 액세스 및 서비스 거부 공격으로 이어질 수 있다.

"ac ed 00 05" 라는 문자열은 직렬화된 데이터의 앞에 항상 나타나는 문자열로, 뒤에 오는 데이터가 직렬화된 데이터라는 것을 알려주는 매직 바이트이다.

![](../img/deserialization-diagram.jpg)

### 직렬화와 역직렬화?
- 자바 프로그램상 어떤 객체 생성 시 그 객체는 메모리에 상주하게되고 프로그램 실행 동안 필요에 따라 사용된다.
- 프로그램 종료시 메모리에 있는 객체는 사라지게 된다.
- 만약 다음에도 동일한 객체 생성 해야하는 경우 파일이나 데이터베이스에 저장해야한다.
- **이때 직렬화를 하게 된다.** 직렬화란 바이트 스트림(Stream of Bytes)이라는 순차적 데이터로 변환하는 과정을 말한다.
- 직렬화의 장점은 프로세스 간 메모리, 파일 또는 데이터베이스에 복잡한 데이터 쓰기가 간단해진다.
- 역질렬화는 직렬화 과정을 반대로 실행하는 것을 말한며 바이트 스트림를 다시 객체로 만들어 원래의 데이터로 만드는 과정을 말한다.
  
역직렬화가 수행되는 곳이 있다면 공격자는 직렬화된 바이트 스트림을 조작하거나 임의의 바이트 스트림을 애플리케이션에 전송함으로써 자바 소프트웨어를 공격을 가능하게 한다.

## 대응방안
자체적으로 역직렬화를 수행하는 경우 
1. 역직렬화 전에 반드시 인증과정 수행
2. 출처를 알 수 없는 경우 역직렬화 거부
3. 가급적 최소 권한으로 가능한 격리된 환경에서 역직렬화 수행
4. 디지털 서명을 구현하여 데이터의 무결성을 확인
<!-- a:4:{i:0;i:132;i:1;s:7:"Mallory";i:2;s:4:"user";

i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";}

 s

a:4:{i:0;i:1;i:1;s:5:"Alice";i:2;s:5:"admin";

i:3;s:32:"b6a8b3bea87fe0e05022f8f3c88bc960";} -->
